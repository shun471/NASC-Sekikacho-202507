#!/bin/bash

# ãƒ©ã‚ºãƒ‘ã‚¤ç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

echo "ðŸš€ ãƒ©ã‚ºãƒ‘ã‚¤ç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "ðŸ“¦ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°ä¸­..."
sudo apt update
sudo apt upgrade -y

# Node.jsã¨npmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã¾ã ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
if ! command -v node &> /dev/null; then
    echo "ðŸ“¦ Node.jsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt-get install -y nodejs
fi

# pnpmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
if ! command -v pnpm &> /dev/null; then
    echo "ðŸ“¦ pnpmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
    npm install -g pnpm
fi

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
echo "ðŸ“¦ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
pnpm install

# TypeScriptã‚’ãƒ“ãƒ«ãƒ‰
echo "ðŸ”¨ TypeScriptã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
pnpm run build

# ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
echo "âš™ï¸ ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­..."
cat > .env << EOF
# ãƒ©ã‚ºãƒ‘ã‚¤ç”¨ç’°å¢ƒè¨­å®š
PORT=3000

# GPIOè¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
USE_MOCK_GPIO=false

# è§£é™¤ã‚³ãƒ¼ãƒ‰è¨­å®š
UNLOCK_CODE=1234

# ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
LOG_LEVEL=info

# ã‚µãƒ¼ãƒãƒ¼è¨­å®š
NODE_ENV=production
EOF

echo "âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo ""
echo "ðŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼š"
echo "1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ public/ ã«é…ç½®"
echo "2. 'pnpm run start' ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
echo "3. ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://[ãƒ©ã‚ºãƒ‘ã‚¤ã®IP]:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹"
echo ""
echo "ðŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼š"
echo "- GPIOã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆ: sudo usermod -a -G gpio \$USER"
echo "- ãƒãƒ¼ãƒˆãŒä½¿ç”¨ä¸­ã®å ´åˆ: .env ã§ PORT ã‚’å¤‰æ›´" 